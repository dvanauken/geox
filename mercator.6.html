<!DOCTYPE html>
<html>
<head>
    <title>Mercator Projection Aspects</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        #mapContainer {
            position: relative;
            transition: all 0.3s ease;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lat-control { color: #0066cc; }
        .lon-control { color: #9932cc; }
        input[type="range"] {
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>Mercator Projection Aspects</h1>
    <div class="controls">
        <div class="control-group">
            <label>
                Aspect Angle (0° = Standard, 90° = Transverse):
                <input type="range" id="rotation" min="0" max="90" value="0" step="1">
            </label>
            <span id="rotationValue">0°</span>
        </div>
        <div class="control-group lat-control">
            <label>
                Central Latitude:
                <input type="range" id="latitude" min="-90" max="90" value="0" step="1">
            </label>
            <span id="latValue">0°</span>
        </div>
        <div class="control-group lon-control">
            <label>
                Central Longitude:
                <input type="range" id="longitude" min="-180" max="180" value="0" step="1">
            </label>
            <span id="lonValue">0°</span>
        </div>
    </div>
    <div id="mapContainer"></div>
    <script>
        const baseWidth = 928;
        const baseHeight = 500;
        let land;
        const container = document.getElementById('mapContainer');

        function calculateDimensions(angle) {
            const radians = angle * Math.PI / 180;
            const width = Math.round(baseWidth * Math.cos(radians) + baseHeight * Math.sin(radians));
            const height = Math.round(baseHeight * Math.cos(radians) + baseWidth * Math.sin(radians));
            return { width, height };
        }

        function createMap(rotation, lat, lon) {
            container.innerHTML = '';
            const { width, height } = calculateDimensions(rotation);

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            container.appendChild(canvas);

            const context = canvas.getContext('2d');
            const graticule = d3.geoGraticule10();
            const outline = {type: "Sphere"};

            const scale = Math.min(width, height) * 0.3;
            const aspect = rotation * Math.PI / 180;
            const lambda = -lon * Math.cos(aspect);
            const phi = -lat * Math.cos(aspect);
            const gamma = rotation;

            const projection = d3.geoMercator()
                .scale(scale)
                .translate([width / 2, height / 2])
                .rotate([lambda, phi, gamma]);

            const path = d3.geoPath(projection, context);
            const [[x0, y0], [x1, y1]] = path.bounds(outline);
            const bboxCenter = [(x0 + x1) / 2, (y0 + y1) / 2];
            const canvasCenter = [width / 2, height / 2];

            projection.translate([
                canvasCenter[0] + (canvasCenter[0] - bboxCenter[0]),
                canvasCenter[1] + (canvasCenter[1] - bboxCenter[1])
            ]);

            const centeredPath = d3.geoPath(projection, context);

            // Draw map
            context.save();
            context.beginPath();
            centeredPath(outline);
            context.clip();
            context.fillStyle = "#fff";
            context.fillRect(0, 0, width, height);

            // Draw graticule
            context.beginPath();
            centeredPath(graticule);
            context.strokeStyle = "#ccc";
            context.stroke();

            // Draw central lines
            const centralMeridian = {
                type: "LineString",
                coordinates: Array.from({length: 180}, (_, i) => [lon, -89 + i])
            };
            const centralParallel = {
                type: "LineString",
                coordinates: Array.from({length: 360}, (_, i) => [-179 + i, lat])
            };

            context.beginPath();
            centeredPath(centralMeridian);
            context.strokeStyle = "#9932cc";
            context.lineWidth = 2;
            context.stroke();

            context.beginPath();
            centeredPath(centralParallel);
            context.strokeStyle = "#0066cc";
            context.lineWidth = 2;
            context.stroke();

            // Draw land
            context.beginPath();
            centeredPath(land);
            context.fillStyle = "#000";
            context.fill();

            context.restore();
            context.beginPath();
            centeredPath(outline);
            context.strokeStyle = "#000";
            context.stroke();
        }

        const slider = document.getElementById('rotation');
        const rotationValue = document.getElementById('rotationValue');
        const latSlider = document.getElementById('latitude');
        const latValue = document.getElementById('latValue');
        const lonSlider = document.getElementById('longitude');
        const lonValue = document.getElementById('lonValue');

        function updateMap() {
            const rotation = parseInt(slider.value);
            const lat = parseInt(latSlider.value);
            const lon = parseInt(lonSlider.value);
            createMap(rotation, lat, lon);
        }

        slider.addEventListener('input', (e) => {
            rotationValue.textContent = `${e.target.value}°`;
            updateMap();
        });

        latSlider.addEventListener('input', (e) => {
            latValue.textContent = `${e.target.value}°`;
            updateMap();
        });

        lonSlider.addEventListener('input', (e) => {
            lonValue.textContent = `${e.target.value}°`;
            updateMap();
        });

        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/land-50m.json')
            .then(world => {
                land = topojson.feature(world, world.objects.land);
                updateMap();
            });
    </script>
</body>
</html>
