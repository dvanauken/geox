<!DOCTYPE html>
<html>
<head>
    <title>Mercator Projection Aspects</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
        }
        #mapContainer {
            position: relative;
            transition: all 0.3s ease;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Mercator Projection Aspects</h1>
    <div class="controls">
        <label>
            Aspect Angle (0째 = Standard, 90째 = Transverse):
            <input type="range" id="rotation" min="0" max="90" value="0">
        </label>
        <span id="rotationValue">0째</span>
    </div>
    <div id="mapContainer"></div>
    <script>
        let baseWidth = 928;
        let baseHeight = 500;
        let land;
        const container = document.getElementById('mapContainer');
        
        function createMap(rotation) {
            // Clear previous map
            container.innerHTML = '';
            
            // Calculate aspect ratio based on rotation
            const angle = rotation * Math.PI / 180;
            const aspectRatio = Math.cos(angle) + Math.sin(angle);
            
            // Adjust dimensions
            const width = rotation <= 45 ? baseWidth : baseHeight;
            const height = rotation <= 45 ? baseHeight : baseWidth;
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            container.appendChild(canvas);
            
            const context = canvas.getContext('2d');
            const graticule = d3.geoGraticule10();
            const outline = {type: "Sphere"};
            
            // Create projection with proper rotation
            const projection = d3.geoMercator()
                .scale(rotation <= 45 ? 150 : 150 * (height/width))
                .translate([width / 2, height / 2])
                .rotate([0, -rotation, 0]); // Rotate around Y-axis
            
            const path = d3.geoPath(projection, context);
            
            // Adjust center
            const [[x0, y0], [x1, y1]] = path.bounds(outline);
            const bboxCenter = [(x0 + x1) / 2, (y0 + y1) / 2];
            const canvasCenter = [width / 2, height / 2];
            
            projection.translate([
                canvasCenter[0] + (canvasCenter[0] - bboxCenter[0]),
                canvasCenter[1] + (canvasCenter[1] - bboxCenter[1])
            ]);
            
            const centeredPath = d3.geoPath(projection, context);
            
            // Draw map
            context.save();
            context.beginPath();
            centeredPath(outline);
            context.clip();
            context.fillStyle = "#fff";
            context.fillRect(0, 0, width, height);
            
            context.beginPath();
            centeredPath(graticule);
            context.strokeStyle = "#ccc";
            context.stroke();
            
            context.beginPath();
            centeredPath(land);
            context.fillStyle = "#000";
            context.fill();
            
            context.restore();
            context.beginPath();
            centeredPath(outline);
            context.strokeStyle = "#000";
            context.stroke();
        }
        
        const slider = document.getElementById('rotation');
        const rotationValue = document.getElementById('rotationValue');
        
        slider.addEventListener('input', (e) => {
            const rotation = parseInt(e.target.value);
            rotationValue.textContent = `${rotation}째`;
            createMap(rotation);
        });
        
        // Load data and initialize
        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/land-50m.json')
            .then(world => {
                land = topojson.feature(world, world.objects.land);
                createMap(0);
            });
    </script>
</body>
</html>